<div
  *ngIf="isLoading"
  class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-30"
>
  <div
    class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl flex items-center gap-3"
  >
    <div
      class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"
    ></div>
    <span class="text-gray-700 dark:text-gray-300">Loading...</span>
  </div>
</div>

<div class="container mx-auto px-4 py-6">
  <!-- Breadcrumb and page actions -->
  <div class="mb-6 flex items-center justify-between">
    <div class="flex flex-col items-start gap-2">
      <h1 class="text-2xl font-bold dark:text-white">Issue Details</h1>
      <span *ngIf="log?.id" class="text-sm text-yellow-500 dark:text-gray-400">
        <span class="text-gray-500 dark:text-gray-400">Project Tag :</span> #
        {{ log?.tag }}</span
      >
    </div>
    <nav>
      <ol class="flex items-center gap-2">
        <li>
          <a
            class="font-medium dark:text-gray-300 cursor-pointer text-gray-700 hover:text-blue-500 transition-colors"
            (click)="onDashboardClick()"
            >Dashboard /</a
          >
        </li>
        <li class="font-medium text-blue-500 cursor-pointer">Issue Details</li>
      </ol>
    </nav>
  </div>

  <!-- Issue Header - Enhanced with better visual hierarchy -->
  <div
    class="bg-white dark:bg-slate-800 rounded-lg shadow-md mb-6 overflow-hidden"
    *ngIf="log"
  >
    <!-- Header section with gradient background -->
    <div
      class="bg-gradient-to-r from-red-500/10 to-indigo-500/10 dark:from-blue-900/30 dark:to-indigo-900/30 p-6 border-b dark:border-gray-700"
    >
      <div
        class="flex flex-col md:flex-row md:justify-between md:items-start gap-4"
      >
        <!-- Issue summary -->
        <div>
          <div class="flex flex-wrap items-center gap-2 mb-3">
            <span class="text-red-600 text-xl font-bold dark:text-red-400">{{
              log.type
            }}</span>
            <span
              [ngClass]="{
                'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300':
                  isIssueHandled(),
                'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300':
                  !isIssueHandled()
              }"
              class="text-xs font-medium px-2.5 py-0.5 rounded-full"
            >
              {{ isIssueHandled() ? "Handled" : "Unhandled" }}
            </span>
            <span
              [ngClass]="{
                'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300':
                  log.severity === 'HIGH',
                'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300':
                  log.severity === 'MEDIUM',
                'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300':
                  log.severity === 'LOW'
              }"
              class="text-xs font-medium px-2.5 py-0.5 rounded-full"
            >
              {{ log.severity }}
            </span>
          </div>
          <p class="text-gray-800 dark:text-gray-200 text-lg font-medium mb-2">
            {{ log.description }}
          </p>
          <div
            class="text-sm text-gray-600 dark:text-gray-400 flex items-center gap-2"
          >
            <span>{{ log.timestamp | date : "medium" }}</span>
            <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
            <span>{{ log.className }}</span>
            <span
              *ngIf="log.errorCode"
              class="w-1 h-1 bg-gray-400 rounded-full"
            ></span>
            <span
              *ngIf="log.errorCode"
              class="text-red-500 dark:text-red-400"
              >{{ log.errorCode }}</span
            >
          </div>
        </div>

        <!-- Action buttons -->
        <div class="flex flex-wrap gap-3">
          <button
            class="px-3 py-2 border dark:border-gray-600 bg-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 inline-flex items-center rounded-full transition-colors shadow-sm"
          >
            <mat-icon class="text-gray-600 dark:text-gray-400"
              >archive</mat-icon
            >
          </button>
        </div>
      </div>
    </div>

    <!-- Issue Stats - Redesigned for better readability -->
    <div
      class="px-6 py-4 grid grid-cols-1 md:grid-cols-3 gap-6 border-b dark:border-gray-700"
    >
      <div class="flex flex-col relative">
        <h3
          class="text-sm text-gray-600 dark:text-gray-400 mb-1 flex items-center gap-1"
        >
          Events
          <button
            class="text-gray-400 dark:text-gray-500"
            matTooltip="Number of times this issue has occurred"
          >
            <mat-icon class="text-sm">info</mat-icon>
          </button>
        </h3>
        <div class="flex items-center gap-3 group">
          <span class="text-xl font-bold dark:text-white">{{
            getOccurrenceCount()
          }}</span>
          <div
            class="flex-1 h-3 bg-gray-200 rounded-full overflow-hidden dark:bg-gray-700"
          >
            <div
              class="h-full bg-blue-500"
              [style.width.%]="getOccurrencePercentage()"
            ></div>
          </div>
          <span class="text-xs text-gray-500 dark:text-gray-400">{{
            getTimeAgo()
          }}</span>

          <!-- Detailed stats popup on hover -->
          <div
            class="absolute left-0 top-full mt-2 z-10 bg-white dark:bg-slate-800 shadow-lg rounded-md border border-gray-200 dark:border-gray-700 p-4 w-72 invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-200 transform translate-y-2 group-hover:translate-y-0"
          >
            <div class="text-sm text-gray-700 dark:text-gray-300 space-y-3">
              <div class="flex justify-between items-center">
                <span class="font-medium">First seen:</span>
                <span>{{ occurrenceStats?.firstSeen | date : "medium" }}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="font-medium">Last seen:</span>
                <span>{{ occurrenceStats?.lastSeen | date : "medium" }}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="font-medium">Total occurrences:</span>
                <span class="font-semibold text-blue-600 dark:text-blue-400">{{
                  occurrenceStats?.count || "Loading..."
                }}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="font-medium">System impact:</span>
                <span class="flex items-center">
                  <span
                    [ngClass]="{
                      'text-red-600 dark:text-red-400':
                        (occurrenceStats?.percentage || 0) > 70,
                      'text-yellow-600 dark:text-yellow-400':
                        (occurrenceStats?.percentage || 0) > 40 &&
                        (occurrenceStats?.percentage || 0) <= 70,
                      'text-green-600 dark:text-green-400':
                        (occurrenceStats?.percentage || 0) <= 40
                    }"
                    >{{ occurrenceStats?.percentage || 0 }}%</span
                  >
                  <mat-icon
                    class="ml-1 text-sm"
                    [ngClass]="{
                      'text-red-500': (occurrenceStats?.percentage || 0) > 70,
                      'text-yellow-500':
                        (occurrenceStats?.percentage || 0) > 40 &&
                        (occurrenceStats?.percentage || 0) <= 70,
                      'text-green-500': (occurrenceStats?.percentage || 0) <= 40
                    }"
                  >
                    {{
                      (occurrenceStats?.percentage || 0) > 70
                        ? "priority_high"
                        : (occurrenceStats?.percentage || 0) > 40
                        ? "warning"
                        : "check_circle"
                    }}
                  </mat-icon>
                </span>
              </div>
              <div
                class="pt-2 text-xs text-gray-500 dark:text-gray-400 border-t dark:border-gray-700"
              >
                <span
                  *ngIf="!isIssueHandled()"
                  class="text-red-500 dark:text-red-400"
                  >This issue is still active and may continue to occur.</span
                >
                <span
                  *ngIf="isIssueHandled()"
                  class="text-green-500 dark:text-green-400"
                  >This issue has been handled with a solution and should no
                  longer occur.</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-col">
        <h3 class="text-sm text-gray-600 dark:text-gray-400 mb-1">First Seen</h3>
        <div class="text-base font-medium dark:text-white">
          {{ log.timestamp | date : "mediumDate" }}
        </div>
        <div class="text-xs text-gray-500 dark:text-gray-400">
          {{ log.timestamp | date : "shortTime" }}
        </div>
      </div>

      <div class="flex flex-col">
        <h3 class="text-sm text-gray-600 dark:text-gray-400 mb-1">Priority</h3>
        <div class="flex items-center">
          <select
            [ngClass]="{
              'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-300':
                log.severity === 'HIGH',
              'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300':
                log.severity === 'MEDIUM',
              'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300':
                log.severity === 'LOW'
            }"
            class="text-sm font-medium px-3 py-2 rounded-md border-0 cursor-pointer"
            [(ngModel)]="log.severity"
            (change)="changePriority($event)"
          >
            <option value="HIGH">HIGH</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="LOW">LOW</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Additional metadata -->
    <div class="px-6 py-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="block text-gray-500 dark:text-gray-400">Project Tag</span>
        <span class="font-medium dark:text-white">{{ log.tag }}</span>
      </div>
      <div>
        <span class="block text-gray-500 dark:text-gray-400">Project ID</span>
        <span class="font-medium dark:text-white">{{ log.projectId }}</span>
      </div>

      <div>
        <span class="block text-gray-500 dark:text-gray-400"
          >Container Name
        </span>
        <span class="font-medium dark:text-white">{{ log.containerName }}</span>
      </div>

      <div>
        <span class="block text-gray-500 dark:text-gray-400">Thread</span>
        <span class="font-medium dark:text-white">{{ log.thread }}</span>
      </div>
    </div>
  </div>

  <!-- Empty state when no log is loaded -->
  <div
    *ngIf="!log && !isLoading"
    class="bg-white dark:bg-slate-800 rounded-lg shadow-md mb-6 p-8 text-center"
  >
    <div
      class="w-20 h-20 mx-auto bg-red-100 dark:bg-red-900/30 flex items-center justify-center rounded-full mb-4"
    >
      <mat-icon class="text-4xl text-red-500 dark:text-red-400"
        >error_outline</mat-icon
      >
    </div>
    <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">
      No Issue Details Available
    </h3>
    <p class="text-gray-500 dark:text-gray-400 mb-6 max-w-md mx-auto">
      The issue details could not be loaded or the issue ID was not provided.
      Please check the URL or try again later.
    </p>
    <button
      (click)="onDashboardClick()"
      class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors shadow-sm"
    >
      Back to Issues
    </button>
  </div>

  <!-- Tabs - Improved design -->
  <div class="mb-6">
    <div class="border-b dark:border-gray-700">
      <ul class="flex -mb-px text-sm font-medium text-center">
        <li class="mr-2">
          <a
            (click)="onTabChange('details')"
            [class.border-blue-500]="activeTab === 'details'"
            [class.text-blue-500]="activeTab === 'details'"
            class="inline-block p-4 border-b-2 cursor-pointer transition-colors flex items-center gap-2"
            [class.border-transparent]="activeTab !== 'details'"
            [class.hover:border-gray-300]="activeTab !== 'details'"
            [class.text-gray-500]="activeTab !== 'details'"
            [class.dark:text-gray-400]="activeTab !== 'details'"
          >
            <mat-icon class="text-base">info</mat-icon>
            Details
          </a>
        </li>
        <li class="mr-2">
          <a
            (click)="onTabChange('tickets')"
            [class.border-blue-500]="activeTab === 'tickets'"
            [class.text-blue-500]="activeTab === 'tickets'"
            class="inline-block p-4 border-b-2 cursor-pointer transition-colors flex items-center gap-2"
            [class.border-transparent]="activeTab !== 'tickets'"
            [class.hover:border-gray-300]="activeTab !== 'tickets'"
            [class.text-gray-500]="activeTab !== 'tickets'"
            [class.dark:text-gray-400]="activeTab !== 'tickets'"
          >
            <mat-icon class="text-base">assignment</mat-icon>
            Tickets
            <span
              *ngIf="tickets.length > 0"
              class="ml-1 text-xs bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 rounded-full px-2 py-0.5"
            >
              {{ tickets.length }}
            </span>
          </a>
        </li>
        <li class="mr-2">
          <a
            (click)="onTabChange('solutions')"
            [class.border-blue-500]="activeTab === 'solutions'"
            [class.text-blue-500]="activeTab === 'solutions'"
            class="inline-block p-4 border-b-2 cursor-pointer transition-colors flex items-center gap-2"
            [class.border-transparent]="activeTab !== 'solutions'"
            [class.hover:border-gray-300]="activeTab !== 'solutions'"
            [class.text-gray-500]="activeTab !== 'solutions'"
            [class.dark:text-gray-400]="activeTab !== 'solutions'"
          >
            <mat-icon class="text-base">lightbulb</mat-icon>
            Solutions
            <span
              *ngIf="hasSolutions()"
              class="ml-1 text-xs bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 rounded-full px-2 py-0.5"
            >
              {{ getSolutionsCount() }}
            </span>
          </a>
        </li>
        <li class="mr-2">
          <a
            (click)="onTabChange('comments')"
            [class.border-blue-500]="activeTab === 'comments'"
            [class.text-blue-500]="activeTab === 'comments'"
            class="inline-block p-4 border-b-2 cursor-pointer transition-colors flex items-center gap-2"
            [class.border-transparent]="activeTab !== 'comments'"
            [class.hover:border-gray-300]="activeTab !== 'comments'"
            [class.text-gray-500]="activeTab !== 'comments'"
            [class.dark:text-gray-400]="activeTab !== 'comments'"
          >
            <mat-icon class="text-base">comment</mat-icon>
            Comments
            <span
              class="ml-1 text-xs bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300 rounded-full px-2 py-0.5"
            >
              {{ getTotalCommentsCount() }}
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Tab Content -->
  <div [ngSwitch]="activeTab">
    <!-- Details Tab -->
    <div *ngSwitchCase="'details'" class="space-y-6">
      <!-- Error Details -->
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow">
        <div class="p-6 border-b dark:border-gray-700">
          <h3 class="font-bold text-lg dark:text-white">Error Details</h3>
        </div>
        <div class="p-6">
          <table class="w-full">
            <tbody>
              <tr class="border-b dark:border-gray-700">
                <td
                  class="py-3 text-sm text-gray-600 dark:text-gray-400 font-medium"
                >
                  Handled
                </td>
                <td class="py-3 text-sm dark:text-gray-300">
                  {{ log?.handled ? "Yes" : "No" }}
                </td>
              </tr>
              <tr class="border-b dark:border-gray-700">
                <td
                  class="py-3 text-sm text-gray-600 dark:text-gray-400 font-medium"
                >
                  Level
                </td>
                <td class="py-3 text-sm dark:text-gray-300">{{ log?.type }}</td>
              </tr>
              <tr class="border-b dark:border-gray-700">
                <td
                  class="py-3 text-sm text-gray-600 dark:text-gray-400 font-medium"
                >
                  Exception Type
                </td>
                <td class="py-3 text-sm dark:text-gray-300">
                  {{ log?.exceptionType }}
                </td>
              </tr>

              <tr class="border-b dark:border-gray-700">
                <td
                  class="py-3 text-sm text-gray-600 dark:text-gray-400 font-medium"
                >
                  Source
                </td>
                <td class="py-3 text-sm text-blue-500 break-all">
                  {{ log?.source }}
                </td>
              </tr>
              <tr class="border-b dark:border-gray-700">
                <td
                  class="py-3 text-sm text-gray-600 dark:text-gray-400 font-medium"
                >
                  Container Name
                </td>
                <td class="py-3 text-sm dark:text-gray-300">
                  {{ log?.containerName }}
                </td>
              </tr>
              <tr class="border-b dark:border-gray-700">
                <td
                  class="py-3 text-sm text-gray-600 dark:text-gray-400 font-medium"
                >
                  Container Id
                </td>
                <td class="py-3 text-sm dark:text-gray-300">
                  {{ log?.containerId }}
                </td>
              </tr>
              <tr>
                <td
                  class="py-3 text-sm text-gray-600 dark:text-gray-400 font-medium"
                >
                  Timestamp
                </td>
                <td class="py-3 text-sm dark:text-gray-300">
                  {{ log?.timestamp }}
                </td>
              </tr>
              <tr>
                <td
                  class="py-3 text-sm text-gray-600 dark:text-gray-400 font-medium"
                >
                  Original Timestamp
                </td>
                <td class="py-3 text-sm dark:text-gray-300">
                  {{ log?.originalTimestamp }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Stack Trace -->
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow">
        <div class="p-6 border-b dark:border-gray-700 flex justify-between">
          <h3 class="font-bold text-lg dark:text-white">Stack Trace</h3>
          <div>
            <button
              (click)="toggleStackTrace()"
              class="px-3 py-1 text-sm border dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-2"
              [ngClass]="{
                'bg-blue-50 dark:bg-blue-900/20': showFullStackTrace
              }"
            >
              <mat-icon class="text-base">{{
                showFullStackTrace ? "unfold_less" : "unfold_more"
              }}</mat-icon>
              {{ showFullStackTrace ? "Show Less" : "Full Stack Trace" }}
            </button>
          </div>
        </div>
        <div class="p-6 overflow-x-auto">
          <pre
            class="text-sm text-gray-800 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 p-4 rounded whitespace-pre-wrap break-words"
            >{{ getStackTrace() }}</pre
          >
        </div>
      </div>
    </div>

    <!-- Tickets Tab -->
    <div *ngSwitchCase="'tickets'" class="space-y-6">
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md">
        <div
          class="p-6 border-b dark:border-gray-700 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4"
        >
          <h3 class="font-bold text-lg dark:text-white">Tickets</h3>
          <div class="flex items-center gap-2">
            <div
              class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg p-1"
            >
              <button
                (click)="ticketsViewMode = 'list'"
                class="p-2 rounded-md transition-colors"
                [ngClass]="{
                  'bg-white dark:bg-gray-600 shadow text-blue-600 dark:text-blue-400':
                    ticketsViewMode === 'list',
                  'text-gray-600 dark:text-gray-400': ticketsViewMode !== 'list'
                }"
                matTooltip="List View"
              >
                <mat-icon>view_list</mat-icon>
              </button>
              <button
                (click)="ticketsViewMode = 'kanban'"
                class="p-2 rounded-md transition-colors"
                [ngClass]="{
                  'bg-white dark:bg-gray-600 shadow text-blue-600 dark:text-blue-400':
                    ticketsViewMode === 'kanban',
                  'text-gray-600 dark:text-gray-400':
                    ticketsViewMode !== 'kanban'
                }"
                matTooltip="Kanban View"
              >
                <mat-icon>view_column</mat-icon>
              </button>
            </div>
            <button
              (click)="createTicket()"
              class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors flex items-center gap-2 shadow-sm"
              [ngClass]="{'opacity-50 hidden': isManager() || isPartner()}"
              >
              <mat-icon class="text-base">add</mat-icon>
              <span>Create Ticket</span>
            </button>
          </div>
        </div>
        <div class="p-6">
          <!-- Loading indicator -->
          <div *ngIf="isLoading" class="text-center py-8">
            <div
              class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"
            ></div>
            <p class="text-gray-600 dark:text-gray-400 text-lg">
              Loading tickets...
            </p>
          </div>

          <!-- No tickets message -->
          <div
            *ngIf="!isLoading && tickets.length === 0"
            class="text-center py-12"
          >
            <div
              class="w-20 h-20 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <mat-icon class="text-4xl text-blue-500 dark:text-blue-400"
                >assignment</mat-icon
              >
            </div>
            <h3 class="text-xl font-medium mb-2 dark:text-white">
              No Tickets Found
            </h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6 max-w-md mx-auto">
              There are no tickets associated with this issue yet. Create a
              ticket to start tracking the resolution process.
            </p>
            <button
              (click)="createTicket()"
              class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors shadow-sm"
            >
              Create First Ticket
            </button>
          </div>

          <!-- Tickets List View - Modern design -->
          <div
            *ngIf="
              !isLoading && tickets.length > 0 && ticketsViewMode === 'list'
            "
            class="space-y-4"
          >
            <div
              *ngFor="let ticket of tickets"
              class="border dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-slate-800 hover:shadow-md transition-shadow"
            >
              <!-- Status header with colored background based on status -->
              <div
                class="px-5 py-3 flex items-center justify-between"
                [ngClass]="{
                  'bg-blue-50 dark:bg-blue-900/20 border-b border-blue-200 dark:border-blue-800':
                    ticket.status === Status.IN_PROGRESS,
                  'bg-green-50 dark:bg-green-900/20 border-b border-green-200 dark:border-green-800':
                    ticket.status === Status.RESOLVED,
                  'bg-purple-50 dark:bg-purple-900/20 border-b border-purple-200 dark:border-purple-800':
                    ticket.status === Status.MERGED_TO_TEST,
                  'bg-teal-50 dark:bg-teal-900/20 border-b border-teal-200 dark:border-teal-800':
                    ticket.status === Status.DONE
                }"
              >
                <div class="flex items-center gap-3">
                  <span
                    [ngClass]="{
                      'bg-gray-100 text-gray-800 dark:bg-gray-900/50 dark:text-gray-300':
                        ticket.status === Status.TO_DO,
                      'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300':
                        ticket.status === Status.IN_PROGRESS,
                      'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300':
                        ticket.status === Status.RESOLVED,
                      'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300':
                        ticket.status === Status.MERGED_TO_TEST,
                      'bg-teal-100 text-teal-800 dark:bg-teal-900/50 dark:text-teal-300':
                        ticket.status === Status.DONE
                    }"
                    class="text-xs font-medium px-3 py-1 rounded-full"
                  >
                    {{ ticket.status }}
                  </span>
                  <span
                    [ngClass]="{
                      'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300':
                        ticket.priority === Priority.HIGH,
                      'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300':
                        ticket.priority === Priority.MEDIUM,
                      'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300':
                        ticket.priority === Priority.LOW,
                      'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300':
                        ticket.priority === Priority.CRITICAL
                    }"
                    class="text-xs font-medium px-3 py-1 rounded-full"
                  >
                    {{ ticket.priority }}
                  </span>
                </div>
                <span class="text-xs text-gray-500 dark:text-gray-400"
                  >ID: #{{ ticket.id }}</span
                >
              </div>

              <!-- Ticket content -->
              <div class="p-5">
                <h4
                  class="text-lg font-medium mb-3 text-gray-900 dark:text-white flex items-center gap-2"
                >
                  <mat-icon
                    [ngClass]="{
                      'text-gray-500 dark:text-gray-400':
                        ticket.status === Status.TO_DO,
                      'text-blue-500 dark:text-blue-400':
                        ticket.status === Status.IN_PROGRESS,
                      'text-green-500 dark:text-green-400':
                        ticket.status === Status.RESOLVED,
                      'text-purple-500 dark:text-purple-400':
                        ticket.status === Status.MERGED_TO_TEST,
                      'text-teal-500 dark:text-teal-400':
                        ticket.status === Status.DONE
                    }"
                  >
                    {{
                      ticket.status === Status.TO_DO
                        ? "assignment"
                        : ticket.status === Status.IN_PROGRESS
                        ? "hourglass_empty"
                        : ticket.status === Status.RESOLVED
                        ? "task_alt"
                        : ticket.status === Status.MERGED_TO_TEST
                        ? "merge_type"
                        : "done_all"
                    }}
                  </mat-icon>
                  {{ ticket.title }}
                </h4>
                <p
                  class="text-sm text-gray-600 dark:text-gray-400 mb-4 whitespace-pre-line"
                >
                  {{ ticket.description }}
                </p>

                <!-- Metadata grid -->
                <div
                  class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 p-4 rounded-md"
                >
                  <div class="flex items-center gap-2">
                    <mat-icon class="text-sm text-gray-400">event</mat-icon>
                    <span class="font-medium">Created:</span>
                    {{ ticket.createdAt | date : "medium" }}
                  </div>
                  <div class="flex items-center gap-2">
                    <mat-icon class="text-sm text-gray-400">person</mat-icon>
                    <span class="font-medium">Assigned to:</span>
                    <span
                      [ngClass]="{
                        'text-red-500': ticket.assignedToEmail === 'No access',
                        'text-gray-500': ticket.assignedToEmail === 'Unknown'
                      }"
                      >{{ ticket.assignedToEmail || "Unassigned" }}</span
                    >
                  </div>
                  <div
                    *ngIf="ticket.hasSolution"
                    class="flex items-center gap-2"
                  >
                    <mat-icon class="text-sm text-green-500"
                      >check_circle</mat-icon
                    >
                    <span class="font-medium">Resolved:</span>
                    {{ ticket.solution?.createdAt | date : "medium" }}
                  </div>
                  <div
                    *ngIf="ticket.hasSolution"
                    class="flex items-center gap-2"
                  >
                    <mat-icon class="text-sm text-blue-500">schedule</mat-icon>
                    <span class="font-medium">Time to Resolution:</span>
                    <span class="text-blue-600 dark:text-blue-400">
                      {{
                        calculateTimeToResolution(
                          ticket.createdAt,
                          ticket.solution?.createdAt
                        )
                      }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Actions footer -->
              <div
                class="px-5 py-3 bg-gray-50 dark:bg-gray-700 border-t border-gray-100 dark:border-gray-600 flex justify-end gap-2"
              >
                <button
                  (click)="viewTicketDetails(ticket)"
                  class="px-3 py-1.5 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors flex items-center gap-1 shadow-sm"
                >
                  <mat-icon class="text-sm">visibility</mat-icon>
                  View Details
                </button>
                <button
                  (click)="editTicket(ticket)"
                  class="px-3 py-1.5 text-sm border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md transition-colors flex items-center gap-1 shadow-sm"
                >
                  <mat-icon class="text-sm">edit</mat-icon>
                  Edit
                </button>
              </div>
            </div>
          </div>

          <!-- Kanban Board View - Updated Structure -->
          <div
            *ngIf="
              !isLoading && tickets.length > 0 && ticketsViewMode === 'kanban'
            "
            class="mt-6 kanban-board"
          >
            <!-- Loop through defined columns -->
            <div
              *ngFor="let column of kanbanColumns"
              class="kanban-column rounded-lg border overflow-hidden"
              [ngClass]="{
                'border-gray-200 dark:border-gray-700': column.color === 'gray',
                'border-blue-200 dark:border-blue-800': column.color === 'blue',
                'border-green-200 dark:border-green-800':
                  column.color === 'green',
                'border-teal-200 dark:border-teal-800': column.color === 'teal',
                'border-purple-200 dark:border-purple-800':
                  column.color === 'purple'
              }"
            >
              <!-- Column Header -->
              <div
                class="column-header p-4 border-b"
                [ngClass]="{
                  'bg-gray-50 dark:bg-gray-800/30 border-gray-200 dark:border-gray-700':
                    column.color === 'gray',
                  'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800':
                    column.color === 'blue',
                  'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800':
                    column.color === 'green',
                  'bg-teal-50 dark:bg-teal-900/20 border-teal-200 dark:border-teal-800':
                    column.color === 'teal',
                  'bg-purple-50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-800':
                    column.color === 'purple'
                }"
              >
                <h3
                  class="font-medium flex items-center"
                  [ngClass]="{
                    'text-gray-700 dark:text-gray-300': column.color === 'gray',
                    'text-blue-800 dark:text-blue-300': column.color === 'blue',
                    'text-green-800 dark:text-green-300':
                      column.color === 'green',
                    'text-teal-800 dark:text-teal-300': column.color === 'teal',
                    'text-purple-800 dark:text-purple-300':
                      column.color === 'purple'
                  }"
                >
                  <mat-icon
                    class="mr-2 text-base"
                    [ngClass]="{
                      'text-gray-500 dark:text-gray-400':
                        column.color === 'gray',
                      'text-blue-600 dark:text-blue-400':
                        column.color === 'blue',
                      'text-green-600 dark:text-green-400':
                        column.color === 'green',
                      'text-teal-600 dark:text-teal-400':
                        column.color === 'teal',
                      'text-purple-600 dark:text-purple-400':
                        column.color === 'purple'
                    }"
                  >
                    {{ column.icon }}
                  </mat-icon>
                  {{ column.name }}
                  <span
                    class="ml-2 rounded-full px-2 py-0.5 text-xs"
                    [ngClass]="{
                      'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300':
                        column.color === 'gray',
                      'bg-blue-200 dark:bg-blue-800 text-blue-800 dark:text-blue-300':
                        column.color === 'blue',
                      'bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-300':
                        column.color === 'green',
                      'bg-teal-200 dark:bg-teal-800 text-teal-800 dark:text-teal-300':
                        column.color === 'teal',
                      'bg-purple-200 dark:bg-purple-800 text-purple-800 dark:text-purple-300':
                        column.color === 'purple'
                    }"
                  >
                    {{ column.tickets.length }}
                  </span>
                  <!-- Role permission hints (optional, can be added similarly to old code) -->
                </h3>
              </div>
              <!-- Column Content (Drop List) -->
              <div
                class="column-content p-3 bg-gray-50 dark:bg-gray-800 min-h-[300px]"
                cdkDropList
                [id]="column.id"
                [cdkDropListData]="column.tickets"
                [cdkDropListConnectedTo]="getConnectedDropLists()"
                (cdkDropListDropped)="drop($event)"
              >
                <!-- Ticket Cards -->
                <div
                  *ngFor="let ticket of column.tickets"
                  class="ticket-card mb-3 p-3 rounded-md shadow-sm hover:shadow-md transition-shadow bg-white dark:bg-gray-700"
                  [ngClass]="'border-' + column.color + '-500'"
                  cdkDrag
                  [cdkDragData]="ticket"
                >
                  <!-- Lock icon if drag disabled -->
                  <div
                    class="absolute top-1 right-1 bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 text-xs font-medium px-1 py-0.5 rounded-full z-10"
                  >
                    <mat-icon class="icon-xs align-text-bottom">lock</mat-icon>
                  </div>

                  <!-- Draggable Handle (optional, can wrap content) -->
                  <div class="cdkDragHandle">
                    <!-- Ticket Header -->
                    <div class="flex justify-between items-start mb-2">
                      <span
                        class="ticket-id text-xs font-medium text-gray-500 dark:text-gray-400"
                        >#{{ ticket.id }}</span
                      >
                      <!-- Assignee Avatar -->
                      <div
                        *ngIf="ticket.assignedToUserId"
                        class="avatar rounded-full w-5 h-5 flex items-center justify-center text-white text-xs"
                        [ngClass]="{
                          'bg-blue-500':
                            ticket.assignedToUserId &&
                            ticket.assignedToUserId % 5 === 0,
                          'bg-amber-500':
                            ticket.assignedToUserId &&
                            ticket.assignedToUserId % 5 === 1,
                          'bg-green-500':
                            ticket.assignedToUserId &&
                            ticket.assignedToUserId % 5 === 2,
                          'bg-purple-500':
                            ticket.assignedToUserId &&
                            ticket.assignedToUserId % 5 === 3,
                          'bg-red-500':
                            ticket.assignedToUserId &&
                            ticket.assignedToUserId % 5 === 4,
                          'bg-gray-400': !ticket.assignedToUserId
                        }"
                      >
                        {{
                          (ticket.assignedToEmail
                            ? ticket.assignedToEmail.charAt(0)
                            : "U"
                          ) | uppercase
                        }}
                      </div>
                      <div
                        *ngIf="!ticket.assignedToUserId"
                        class="avatar rounded-full w-5 h-5 flex items-center justify-center text-white text-xs bg-gray-400"
                        matTooltip="Unassigned"
                      >
                        U
                      </div>
                    </div>
                    <!-- Ticket Title -->
                    <h5
                      class="ticket-title text-sm font-medium text-gray-900 dark:text-white mb-1.5 line-clamp-2"
                    >
                      {{ ticket.title }}
                    </h5>
                    <!-- Ticket Description (Optional Snippet) -->
                    <p
                      *ngIf="ticket.description"
                      class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2 mb-2"
                    >
                      {{ ticket.description }}
                    </p>
                  </div>

                  <!-- Ticket Footer -->
                  <div
                    class="ticket-footer flex items-center justify-between border-t border-gray-100 dark:border-gray-600 pt-2 mt-2"
                  >
                    <!-- Priority Tag -->
                    <span
                      class="priority-pill text-xs px-2 py-0.5 rounded-full"
                      [ngClass]="{
                        'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300':
                          ticket.priority === Priority.LOW,
                        'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300':
                          ticket.priority === Priority.MEDIUM,
                        'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300':
                          ticket.priority === Priority.HIGH,
                        'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300':
                          ticket.priority === Priority.CRITICAL
                      }"
                    >
                      {{ ticket.priority }}
                    </span>
                    <!-- Action Buttons (View Details, etc.) -->
                    <div class="flex gap-1">
                      <button
                        (click)="
                          $event.stopPropagation(); viewTicketDetails(ticket)
                        "
                        class="text-xs p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-500 dark:text-gray-400 transition-colors cdkDragDisableHandle"
                        matTooltip="View Details"
                      >
                        <mat-icon class="icon-xs">visibility</mat-icon>
                      </button>
                      <button
                        *ngIf="column.id === 'resolvedList'"
                        (click)="
                          $event.stopPropagation();
                          updateTicketStatus(ticket.id!, Status.MERGED_TO_TEST)
                        "
                        class="text-xs p-1 rounded hover:bg-purple-100 dark:hover:bg-purple-800 text-purple-600 dark:text-purple-400 transition-colors cdkDragDisableHandle"
                        matTooltip="Mark as Merged to Test"
                      >
                        <mat-icon class="icon-xs">merge_type</mat-icon>
                      </button>
                    </div>
                  </div>

                  <!-- Drag Preview -->
                  <div
                    *cdkDragPreview
                    class="cdk-drag-preview p-3 w-64 ticket-card"
                    [ngClass]="'border-' + column.color + '-500'"
                  >
                    <div class="flex justify-between items-start mb-1">
                      <span
                        class="ticket-id text-xs font-medium text-gray-500 dark:text-gray-400"
                        >#{{ ticket.id }}</span
                      >
                      <span
                        class="priority-pill text-xs px-2 py-0.5 rounded-full"
                        [ngClass]="{
                          'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300':
                            ticket.priority === Priority.LOW,
                          'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300':
                            ticket.priority === Priority.MEDIUM,
                          'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300':
                            ticket.priority === Priority.HIGH,
                          'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300':
                            ticket.priority === Priority.CRITICAL
                        }"
                      >
                        {{ ticket.priority }}
                      </span>
                    </div>
                    <h4
                      class="ticket-title text-sm font-medium text-gray-900 dark:text-white mb-1 line-clamp-1"
                    >
                      {{ ticket.title }}
                    </h4>
                    <p
                      class="text-xs text-gray-500 dark:text-gray-400 line-clamp-1"
                    >
                      Dragging...
                    </p>
                  </div>
                  <!-- Placeholder for drag operation -->
                  <div *cdkDragPlaceholder class="cdk-drag-placeholder"></div>
                </div>
                <!-- Empty Column Message -->
                <div
                  *ngIf="column.tickets.length === 0"
                  class="flex flex-col items-center justify-center h-24 text-gray-400 dark:text-gray-500 text-sm italic"
                >
                  <mat-icon
                    class="text-3xl text-gray-300 dark:text-gray-600 mb-2"
                    >inbox</mat-icon
                  >
                  No tickets in {{ column.name }}
                </div>
              </div>
            </div>
          </div>

          <!-- Role Permissions Legend -->
          <div
            class="mt-4 p-4 bg-white dark:bg-darksecondry rounded-lg border border-gray-200 dark:border-gray-700"
          >
            <h4
              class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Role Permissions:
            </h4>
            <div class="flex flex-wrap gap-4">
              <div
                class="flex items-center text-xs text-gray-600 dark:text-gray-400"
              >
                <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                <span *ngIf="userRole === 'DEVELOPER'"
                  >Developers can move tickets to IN_PROGRESS or RESOLVED</span
                >
                <span *ngIf="userRole === 'TESTER'"
                  >Testers can move tickets to DONE</span
                >
                <span *ngIf="userRole === 'MANAGER'"
                  >Managers can move tickets to TO_DO or MERGED_TO_TEST</span
                >
              </div>
              <div
                *ngIf="userRole !== 'ADMIN'"
                class="flex items-center text-xs text-gray-600 dark:text-gray-400"
              >
                <mat-icon class="text-gray-400 mr-1 icon-xs">lock</mat-icon>
                <span
                  >Locked tickets cannot be moved due to role permissions</span
                >
              </div>
              <div
                *ngIf="userRole === 'TESTER'"
                class="flex items-center text-xs text-gray-600 dark:text-gray-400"
              >
                <mat-icon class="text-gray-400 mr-1 icon-xs"
                  >visibility</mat-icon
                >
                <span>Grayed out columns are read-only for testers</span>
              </div>
              <div
                *ngIf="userRole === 'ADMIN'"
                class="flex items-center text-xs text-green-600 dark:text-green-400"
              >
                <mat-icon class="text-green-400 mr-1 icon-xs"
                  >admin_panel_settings</mat-icon
                >
                <span>Admins can move tickets to any status</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Comments Tab -->
    <div *ngSwitchCase="'comments'" class="space-y-6">
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md">
        <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center">
          <div class="flex items-center gap-3">
            <h3 class="font-bold text-lg dark:text-white">Comments</h3>
            <span class="text-sm px-2.5 py-1 rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300">
              {{ getTotalCommentsCount() }}
            </span>
          </div>
          <button 
            (click)="refreshComments()" 
            class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400"
            [disabled]="isLoadingComments"
            matTooltip="Refresh comments">
            <mat-icon [class.animate-spin]="isLoadingComments">refresh</mat-icon>
          </button>
        </div>

        <div class="divide-y dark:divide-gray-700">
          <!-- Add Comment Section -->
          <div class="p-6 bg-gray-50 dark:bg-gray-800/50">
            <form #commentForm="ngForm" (ngSubmit)="submitComment()" class="space-y-4">
              <div>
                <!-- New Comment Textarea -->
                <div class="relative">
                  <textarea
                    #newCommentTextarea
                    [(ngModel)]="newCommentText"
                    (input)="handleInput($event, false)"
                    placeholder="Type your comment here..."
                    class="w-full rounded-md border dark:border-gray-600 shadow-sm p-3 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                    rows="3"
                  ></textarea>

                  <!-- Member Suggestions Dropdown for New Comment -->
                  <div *ngIf="showNewCommentSuggestions" class="absolute z-50 left-0 right-0 mt-1">
                    <div class="bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-md shadow-lg max-h-60 overflow-y-auto">
                      <div *ngFor="let member of filteredMembers" 
                           (click)="selectMember(member, false)"
                           class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer flex items-center space-x-2">
                        <div class="h-8 w-8 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center">
                          <span class="text-purple-700 dark:text-purple-300 text-sm font-medium">
                            {{ member.firstname?.charAt(0) || member.email?.charAt(0)?.toUpperCase() }}
                          </span>
                        </div>
                        <div class="flex flex-col">
                          <span class="text-sm font-medium text-gray-900 dark:text-gray-100">
                            {{ member.firstname || 'User' }}
                          </span>
                          <span class="text-xs text-gray-500 dark:text-gray-400">
                            {{ member.email }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-500 dark:text-gray-400">
                  Use &#64; to mention someone
                </span>
                <button
                  (click)="submitComment()"
                  [disabled]="!newCommentText.trim() || isSubmittingComment"
                  class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
                >
                  Submit
                </button>
              </div>
            </form>
          </div>

          <!-- Comments List Section -->
          <div class="p-6">
            <!-- Error State -->
            <div *ngIf="commentError" class="mb-6 rounded-md bg-red-50 dark:bg-red-900/30 p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <mat-icon class="h-5 w-5 text-red-400">error_outline</mat-icon>
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-red-800 dark:text-red-200">Error</h3>
                  <div class="mt-2 text-sm text-red-700 dark:text-red-300">
                    {{ commentError }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Loading State -->
            <div *ngIf="isLoadingComments" class="flex justify-center py-12">
              <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-purple-500"></div>
            </div>

            <!-- Empty State -->
            <div *ngIf="!isLoadingComments && (!comments || comments.length === 0)" class="text-center py-12">
              <div class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-600">
                <mat-icon class="h-12 w-12 text-4xl">chat_bubble_outline</mat-icon>
              </div>
              <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-100">No comments yet</h3>
              <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Start the conversation by adding the first comment.</p>
            </div>

            <!-- Comments List -->
            <div *ngIf="!isLoadingComments && comments && comments.length > 0" class="space-y-6">
              <div *ngFor="let comment of comments" class="relative">
                <div [class.ml-10]="comment.parentCommentId" class="bg-white dark:bg-gray-800 rounded-lg border dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow">
                  <!-- Comment Header -->
                  <div class="p-4 flex items-start space-x-3">
                    <div class="flex-shrink-0">
                      <div class="h-10 w-10 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center">
                        <span class="text-purple-700 dark:text-purple-300 font-medium">
                          {{ getUserEmail(comment.authorUserId)?.charAt(0)?.toUpperCase() || 'U' }}
                        </span>
                      </div>
                    </div>
                    <div class="min-w-0 flex-1">
                      <div class="flex items-center justify-between">
                        <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100">
                         <b>{{ getUserEmail(comment.authorUserId) }}</b> 
                        </h4>
                        <div class="flex items-center space-x-2">
                          <span class="text-sm text-gray-500 dark:text-gray-400">
                            {{ comment.createdAt | date:'medium' }}
                          </span>
                          <!-- Comment Actions Menu -->
                          <div class="relative" *ngIf="canEditComment(comment) || canDeleteComment(comment)">
                            <button 
                              type="button"
                              class="p-1 rounded-full text-gray-400 hover:text-gray-500 dark:hover:text-gray-300"
                              [matMenuTriggerFor]="commentMenu">
                              <mat-icon>more_vert</mat-icon>
                            </button>
                            <mat-menu #commentMenu="matMenu">
                              <button mat-menu-item *ngIf="canEditComment(comment)" (click)="editComment(comment)">
                                <mat-icon>edit</mat-icon>
                                <span>Edit</span>
                              </button>
                              <button mat-menu-item *ngIf="canDeleteComment(comment)" (click)="deleteComment(comment)">
                                <mat-icon>delete</mat-icon>
                                <span>Delete</span>
                              </button>
                            </mat-menu>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Comment Content -->
                      <div class="mt-2 text-sm text-gray-700 dark:text-gray-300 space-y-4">
                        <!-- Edit Mode -->
                        <div *ngIf="editingCommentId === comment.id">
                          <div *ngIf="editingCommentId" class="relative mt-4">
                            <textarea
                              #editCommentTextarea
                              [(ngModel)]="editCommentText"
                              (input)="handleInput($event, true)"
                              placeholder="Edit your comment..."
                              class="w-full rounded-md border dark:border-gray-600 shadow-sm p-3 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                              rows="3"
                            ></textarea>

                            <!-- Member Suggestions Dropdown for Edit -->
                            <div *ngIf="showEditCommentSuggestions" class="absolute z-50 left-0 right-0 mt-1">
                              <div class="bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                <div *ngFor="let member of filteredMembers" 
                                     (click)="selectMember(member, true)"
                                     class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer flex items-center space-x-2">
                                  <div class="h-8 w-8 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center">
                                    <span class="text-purple-700 dark:text-purple-300 text-sm font-medium">
                                      {{ member.firstname?.charAt(0) || member.email?.charAt(0)?.toUpperCase() }}
                                    </span>
                                  </div>
                                  <div class="flex flex-col">
                                    <span class="text-sm font-medium text-gray-900 dark:text-gray-100">
                                      {{ member.firstname || 'User' }}
                                    </span>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">
                                      {{ member.email }}
                                    </span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="mt-3 flex justify-end space-x-3">
                            <button
                              type="button"
                              (click)="cancelEditOrReply()"
                              class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                              Cancel
                            </button>
                            <button
                              type="button"
                              (click)="saveEditedComment(comment)"
                              class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 transition-colors">
                              Save Changes
                            </button>
                          </div>
                        </div>
                        
                        <!-- View Mode -->
                        <div *ngIf="editingCommentId !== comment.id">
                          <div [innerHTML]="formatCommentWithMentions(comment)" class="prose prose-sm dark:prose-invert max-w-none"></div>
                          
                          <!-- Reply Form -->
                          <div *ngIf="replyingToCommentId === comment.id" class="mt-4">
                            <textarea
                              [(ngModel)]="replyText"
                              class="w-full rounded-md border dark:border-gray-600 shadow-sm p-3 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                              rows="3"
                              placeholder="Write your reply..."></textarea>
                            <div class="mt-3 flex justify-end space-x-3">
                              <button
                                type="button"
                                (click)="cancelReply()"
                                class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                Cancel
                              </button>
                              <button
                                type="button"
                                (click)="submitReply(comment)"
                                [disabled]="!replyText.trim()"
                                class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                Reply
                              </button>
                            </div>
                          </div>
                          
                          <!-- Comment Actions -->
                          <div *ngIf="replyingToCommentId !== comment.id" class="mt-4 flex space-x-3">
                            <button
                              type="button"
                              (click)="replyToComment(comment)"
                              class="inline-flex items-center text-sm text-gray-500 dark:text-gray-400 hover:text-purple-600 dark:hover:text-purple-400 transition-colors">
                              <mat-icon class="h-4 w-4 mr-1">reply</mat-icon>
                              Reply
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Solutions Tab -->
    <div *ngSwitchCase="'solutions'" class="space-y-6">
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md">
        <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center">
          <h3 class="font-bold text-lg dark:text-white">Solutions</h3>
        
          <button *ngIf="tickets.length > 0" 
                  [disabled]="isManager()"
                  (click)="addSolution()" 
                  [ngClass]="{'opacity-50 hidden': isManager() || isPartner()}"
                  class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md transition-colors shadow-sm flex items-center gap-2"
          > <mat-icon class="text-base">add</mat-icon>
            <span>Add Solution</span>
          </button>
        </div>
        
        <!-- Sub-tabs for solutions -->
        <div class="border-b dark:border-gray-700">
          <ul class="flex text-sm font-medium text-center">
            <li class="mr-2">
              <a (click)="onSolutionsTabChange('my-solutions')" 
                 [class.border-green-500]="activeSolutionsTab === 'my-solutions'"
                 [class.text-green-500]="activeSolutionsTab === 'my-solutions'"
                 class="inline-block p-4 border-b-2 cursor-pointer transition-colors flex items-center gap-2"
                 [class.border-transparent]="activeSolutionsTab !== 'my-solutions'"
                 [class.hover:border-gray-300]="activeSolutionsTab !== 'my-solutions'"
                 [class.text-gray-500]="activeSolutionsTab !== 'my-solutions'"
                 [class.dark:text-gray-400]="activeSolutionsTab !== 'my-solutions'">
                  <mat-icon class="text-base">check_circle</mat-icon>
                  {{ isPartner() || isManager() ? 'Implemented Solutions' : 'My Solutions'  }}
                 <span *ngIf="hasSolutions()" 
                       class="ml-1 text-xs bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 rounded-full px-2 py-0.5">
                    {{ getSolutionsCount() }}
                 </span>
              </a>
            </li>
            <li class="mr-2">
              <a (click)="onSolutionsTabChange('developer-solutions')"
                 [class.border-blue-500]="activeSolutionsTab === 'developer-solutions'"
                 [class.text-blue-500]="activeSolutionsTab === 'developer-solutions'"
                 class="inline-block p-4 border-b-2 cursor-pointer transition-colors flex items-center gap-2"
                 [class.border-transparent]="activeSolutionsTab !== 'developer-solutions'"
                 [class.hover:border-gray-300]="activeSolutionsTab !== 'developer-solutions'"
                 [class.text-gray-500]="activeSolutionsTab !== 'developer-solutions'"
                 [class.dark:text-gray-400]="activeSolutionsTab !== 'developer-solutions'">
                 <mat-icon class="text-base">group</mat-icon>
                 Developer Community
                 <span class="ml-1 text-xs bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 rounded-full px-2 py-0.5">
                    {{ developerSolutions.length }}
                 </span>
              </a>
            </li>
            <li class="mr-2">
              <a (click)="onSolutionsTabChange('ai-solutions')"
                 [class.border-purple-500]="activeSolutionsTab === 'ai-solutions'"
                 [class.text-purple-500]="activeSolutionsTab === 'ai-solutions'"
                 class="inline-block p-4 border-b-2 cursor-pointer transition-colors flex items-center gap-2"
                 [class.border-transparent]="activeSolutionsTab !== 'ai-solutions'"
                 [class.hover:border-gray-300]="activeSolutionsTab !== 'ai-solutions'"
                 [class.text-gray-500]="activeSolutionsTab !== 'ai-solutions'"
                 [class.dark:text-gray-400]="activeSolutionsTab !== 'ai-solutions'">
                 <mat-icon class="text-base">smart_toy</mat-icon>
                 AI Recommendations
                 <span class="ml-1 text-xs bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300 rounded-full px-2 py-0.5">
                    1
                 </span>
              </a>
            </li>
          </ul>
        </div>
        
        <div class="p-6">
          <!-- Loading state -->
          <div *ngIf="isLoading" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-600 dark:text-gray-400 text-lg">Loading solutions...</p>
          </div>
          
          <!-- First-time user guidance -->
          <div *ngIf="!isLoading" class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg mb-6 flex items-start gap-3">
            <div class="mt-1 text-yellow-500 dark:text-yellow-400">
              <mat-icon>lightbulb</mat-icon>
            </div>
            <div>
              <h4 class="font-medium text-gray-800 dark:text-white mb-1">How Solutions Work</h4>
              <p class="text-sm text-gray-600 dark:text-gray-300">
                Solutions provide step-by-step guidance to fix issues. They include technical details and are written in markdown format for better readability. 
                Each solution has complexity and time estimations to help you understand the effort required.
              </p>
            </div>
          </div>
          
          <!-- Content based on active solutions tab -->
          <div [ngSwitch]="activeSolutionsTab">
            
            <!-- My Solutions Tab -->
            <div *ngSwitchCase="'my-solutions'" class="space-y-6">
              <!-- Implemented Solutions list -->
              <div *ngIf="!isLoading && hasSolutions()" class="border dark:border-gray-700 rounded-lg overflow-hidden mb-6">
                <div class="bg-green-50 dark:bg-green-900/20 p-4 border-b border-green-200 dark:border-green-700 flex justify-between items-start">
                  <div>
                    <h4 class="text-lg font-medium dark:text-white flex items-center gap-2">
                      <mat-icon class="text-green-600 dark:text-green-400">check_circle</mat-icon>
                  Implemented Solutions
                      <span class="ml-2 px-2 py-0.5 inline-flex items-center text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300">
                        <mat-icon class="text-sm relative top-[1px]">done_all</mat-icon>
                        <span class="leading-none">{{ getSolutionsCount() }} solutions</span>
                      </span>
                </h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                      Solutions that have been implemented and verified for this issue
                    </p>
                  </div>
               
                </div>

                <!-- Solutions list -->
                <div class="divide-y divide-gray-100 dark:divide-gray-700">
                  <ng-container *ngFor="let ticket of tickets">
                    <div *ngIf="ticket" class="p-6" [class.bg-green-50]="ticket.hasSolution" [class.dark:bg-green-900]="ticket.hasSolution">
                      <div class="flex justify-between items-start mb-4">
                        <div>
                          <h5 class="text-lg font-medium text-gray-900 dark:text-white mb-1 flex items-center gap-2">
                            Ticket #{{ticket?.id}}
                            <span class="px-3 py-1 text-xs font-medium rounded-full" 
                                  [ngClass]="{
                                    'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300': ticket?.status === Status.TO_DO,
                                    'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300': ticket?.status === Status.DONE,
                                    'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300': ticket?.status === Status.RESOLVED,
                                    'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300': ticket?.status === Status.MERGED_TO_TEST,
                                    'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300': ticket?.status === Status.IN_PROGRESS
                                  }">
                              {{ticket?.status}}
                            </span>
                          </h5>
                          <p class="text-sm text-gray-500 dark:text-gray-400">{{ticket?.title}}</p>
                        </div>
                      </div>
                        
                      <!-- Solution content -->
                      <div class="prose prose-sm dark:prose-invert max-w-none mb-4">
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border dark:border-gray-700">
                          <h6 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Solution Description</h6>
                          <markdown [data]="ticket?.solution ? getSolutionContent(ticket) : 'No description available'"
                                  class="markdown-body dark:text-gray-300"
                                  [ngClass]="{'dark-theme': isDarkMode()}"
                                  [inline]="true"></markdown>
                        </div>
                      </div>
                        
                      <!-- Solution metadata -->
                      <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <span class="text-gray-500 dark:text-gray-400">Complexity:</span>
                          <span class="ml-2 font-medium" [ngClass]="ticket?.solution ? getComplexityClass(ticket) : ''">
                            {{ticket?.solution ? (getSolutionProperty(ticket, 'complexity') || 'Not specified') : 'Not specified'}}
                          </span>
                        </div>
                        <div>
                          <span class="text-gray-500 dark:text-gray-400">Estimated Time:</span>
                          <span class="ml-2 font-medium text-gray-900 dark:text-white">
                            {{ticket?.solution ? (getSolutionProperty(ticket, 'estimatedTime') || 'Not specified') : 'Not specified'}} mins
                          </span>
                        </div>
                      </div>
                        
                      <!-- Action buttons -->
                      <div class="flex justify-end gap-2 mt-4">
                        <button *ngIf="ticket" 
                                (click)="viewTicketDetails(ticket)" 
                                class="px-3 py-1.5 text-sm bg-green-500 hover:bg-green-600 text-white rounded-md transition-colors flex items-center gap-1">
                          <mat-icon class="text-sm">visibility</mat-icon>
                          View Details
                        </button>
                        <button *ngIf="ticket?.solution" 
                                (click)="editSolution(ticket)" 
                                class="px-3 py-1.5 text-sm border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-md transition-colors flex items-center gap-1">
                          <mat-icon class="text-sm">edit</mat-icon>
                          Edit Solution
                        </button>
                      </div>
                    </div>
                  </ng-container>
                </div>
              </div>
              
              <!-- No solutions message -->
              <div *ngIf="!isLoading && !hasSolutions()" class="text-center py-12">
                <div class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                  <mat-icon class="text-4xl text-green-500 dark:text-green-400">lightbulb</mat-icon>
                </div>
                <h3 class="text-xl font-medium mb-2 dark:text-white">No Solutions Implemented</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6 max-w-md mx-auto">There are no solutions implemented for this issue yet. Create a solution by selecting a ticket and providing the implementation details.</p>
                <button (click)="addSolution()" 
                        [disabled]="isManager()" 
                        class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md transition-colors shadow-sm flex items-center gap-2 mx-auto"
                        [ngClass]="{'opacity-50 cursor-not-allowed': isManager()}">
                  <mat-icon class="text-base">add</mat-icon>
                  Create First Solution
                </button>
              </div>
            </div>
            
            <!-- Developer Community Tab -->
            <div *ngSwitchCase="'developer-solutions'" class="space-y-6">
              <!-- Developer Recommended Solutions -->
              <div class="border dark:border-gray-700 rounded-lg overflow-hidden mb-6">
                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 border-b border-blue-200 dark:border-blue-700 flex justify-between items-start">
                  <div>
                    <h4 class="text-lg font-medium dark:text-white flex items-center gap-2">
                      <mat-icon class="text-blue-600 dark:text-blue-400">group</mat-icon>
                      Developer Community Solutions
                      <span class="ml-2 px-2 py-0.5 inline-flex items-center text-xs rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300">
                        <mat-icon class="text-sm relative top-[1px]">forum</mat-icon>
                        <span class="leading-none">{{ developerSolutions.length }} solutions</span>
                      </span>
                    </h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                      Solutions to similar issues that have been proposed by other colleagues.
                    </p>
                  </div>
                  <div *ngIf="errorMessage" class="text-red-500 text-sm">
                    {{ errorMessage }}
                  </div>
                </div>
                    
                <div class="divide-y dark:divide-gray-700">
                  <!-- Loading message -->
                  <div *ngIf="isLoading" class="p-6 text-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <p class="text-gray-600 dark:text-gray-400">Searching for similar solutions...</p>
                  </div>
                  
                  <!-- No solutions message -->
                  <div *ngIf="!isLoading && developerSolutions.length === 0 && !errorMessage" class="p-6 text-center">
                    <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                      <mat-icon class="text-3xl text-blue-500 dark:text-blue-400">search</mat-icon>
                    </div>
                    <h3 class="text-lg font-medium mb-2 dark:text-white">No Similar Solutions Found</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4 max-w-md mx-auto">
                      We couldn't find any similar solutions in our logs database. This might be a unique issue.
                    </p>
                  </div>
                  
                  <!-- Solutions content from the API -->
                  <div *ngFor="let solution of developerSolutions; let i = index" class="p-4">
                    <div class="flex justify-between mb-3">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                          <span class="font-bold text-blue-600 dark:text-blue-400">{{ solution.sourceIcon }}</span>
                        </div>
                        <div>
                          <h5 class="font-medium text-gray-900 dark:text-white">{{ solution.title }}</h5>
                          <p class="text-xs text-gray-500 dark:text-gray-400">
                            Posted by: {{ solution.authorName || 'Unknown Author' }} • 
                            Similarity: {{ solution.similarity }}
                          </p>
                        </div>
                      </div>
                      <div class="flex items-center text-sm">
                        <span class="text-green-600 dark:text-green-400 font-medium bg-green-50 dark:bg-green-900/20 px-2 py-1 rounded-md flex items-center">
                          <mat-icon class="text-sm mr-1">link</mat-icon>
                          {{ solution.id }}
                        </span>
                      </div>
                    </div>
                    
                    <div class="prose prose-sm sm:prose-base dark:prose-invert max-w-none prose-headings:font-semibold prose-a:text-blue-600 dark:prose-a:text-blue-400 mb-4">
                      <div *ngIf="solution.code">
                        <p>{{ solution.code }}</p>
                      </div>
                      <div class="bg-slate-950 dark:bg-gray-800 p-3 rounded-md text-gray-100 dark:text-gray-200 font-mono text-sm my-3">
                      <markdown *ngIf="solution.content" [data]="solution.content" 
                               class="dark:text-gray-300"
                               [ngClass]="{'dark-theme': isDarkMode()}"></markdown>
                      </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <span class="text-blue-600 dark:text-blue-400 text-sm">{{ solution.errorType || 'Error' }}</span>
                        <span *ngIf="solution.severity" class="text-xs px-2 py-0.5 rounded-full"
                              [ngClass]="{
                                'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300': solution.severity === 'HIGH',
                                'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300': solution.severity === 'MEDIUM',
                                'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300': solution.severity === 'LOW'
                              }">
                          {{ solution.severity }}
                        </span>
                      </div>
                      <div class="flex gap-2">
                        <button (click)="copySolutionCode(solution)" class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                          <mat-icon class="text-sm">content_copy</mat-icon>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
            
                <!-- View more solutions -->
                <div *ngIf="developerSolutions.length > 0" class="p-4 bg-gray-50 dark:bg-gray-700/50 text-center">
                  <button (click)="viewMoreDeveloperSolutions()" class="text-blue-600 dark:text-blue-400 hover:underline font-medium flex items-center justify-center gap-1 mx-auto">
                    View more solutions
                    <mat-icon class="text-sm">arrow_forward</mat-icon>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- AI Recommendations Tab -->
            <div *ngSwitchCase="'ai-solutions'" class="space-y-6">
              <!-- AI Recommended Solutions Section -->
              <div class="border dark:border-gray-700 rounded-lg overflow-hidden mb-6">
                <div class="bg-purple-50 dark:bg-purple-900/20 p-4 border-b border-purple-200 dark:border-purple-700 flex justify-between items-start">
                  <div>
                    <h4 class="text-lg font-medium dark:text-white flex items-center gap-2">
                      <mat-icon class="text-purple-600 dark:text-purple-400">smart_toy</mat-icon>
                      AI Recommended Solution
                      <span class="ml-2 px-2 py-0.5 inline-flex items-center text-xs rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300">
                        <mat-icon class="text-sm relative top-[1px]">auto_awesome</mat-icon>
                        <span class="leading-none">Automated</span>
                      </span>
                    </h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                      AI-powered analysis and suggested fix for this issue
                    </p>
                  </div>
                  <div class="flex gap-2">
                <span class="text-xs inline-flex items-center bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300 px-3 py-1 rounded-full">
                  <mat-icon class="text-sm mr-1">assessment</mat-icon>
                  98% confidence
                </span>
                <button (click)="markAsSolutionHelpful()" class="text-xs px-3 py-1 inline-flex items-center bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 rounded-full hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors">
                  <mat-icon class="text-sm mr-1">thumb_up</mat-icon>
                  Helpful
                </button>
              </div>
            </div>
            
            <div class="p-4">
              <!-- AI Analysis -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-md">
                  <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3 flex items-center">
                    <mat-icon class="text-sm mr-2 text-red-500 dark:text-red-400">error_outline</mat-icon>
                    Root Exception
                  </h5>
                  <p class="text-gray-800 dark:text-gray-200 font-mono text-sm">{{log?.analysis?.['root_exception']}}</p>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-md">
                  <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3 flex items-center">
                    <mat-icon class="text-sm mr-2 text-orange-500 dark:text-orange-400">place</mat-icon>
                    Location
                  </h5>
                  <p class="text-gray-800 dark:text-gray-200 font-mono text-sm">{{log?.analysis?.['location']}}</p>
                </div>
                
                <div class="col-span-1 md:col-span-2 bg-gray-50 dark:bg-gray-700/50 p-4 rounded-md">
                  <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3 flex items-center">
                    <mat-icon class="text-sm mr-2 text-blue-500 dark:text-blue-400">info</mat-icon>
                    Cause
                  </h5>
                  <p class="text-gray-800 dark:text-gray-200 text-sm">
                    {{log?.analysis?.['cause']}}
                  </p>
                </div>
              </div>
              
              <!-- Exception Chain -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
                  Exception Chain ({{log?.analysis?.['length']}})
                </h5>
                <div class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700/50 p-3 rounded-md">
                  <ng-container *ngFor="let exception of log?.analysis?.['exception_chain']; let i = index">
                    <div class="flex items-start gap-2" [class.mb-2]="i !== log?.analysis?.['length'] - 1">
                      <div class="w-5 h-5 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center text-xs text-red-600 dark:text-red-400 font-medium mt-0.5">{{i + 1}}</div>
                      <span class="font-mono text-sm">{{exception}}</span>
                    </div>
                  </ng-container>
                </div>
              </div>
              
              <!-- AI Recommendation -->
              <div class="mb-4">
                <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
                  <mat-icon class="text-green-500 dark:text-green-400">lightbulb</mat-icon>
                  Recommendation
                </h5>
                <div class="text-gray-50 dark:text-gray-950 bg-green-950 dark:bg-green-200 p-4 rounded-md">
                  <p class="text-sm mb-3">
                    {{log?.analysis?.['recommendation']}}
                  </p>
                  <div *ngIf="log?.analysis?.['code']" class="bg-slate-950 dark:bg-gray-800 p-3 rounded-md text-gray-100 dark:text-gray-200 font-mono text-sm mb-3">
                    <div class="whitespace-pre-wrap">
                      {{log?.analysis?.['code']}}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
 
     
    