<div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
  <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <h2 class="text-title-md2 font-bold text-black dark:text-white">
      Kanban Board
    </h2>
    <nav>
      <ol class="flex items-center gap-2">
        <li>
          <a class="font-medium dark:text-gray-300 text-gray-700" routerLink="/dashboard">Dashboard</a> /
        </li>
        <li class="font-medium text-purple-500">Kanban Board</li>
      </ol>
    </nav>
  </div>

  <!-- Filter Controls -->
  <div class="mb-6 bg-white dark:bg-darksecondry dark:border-gray-700 border rounded-lg shadow-md p-4">
    <div class="flex flex-wrap gap-4 items-center justify-between">
      <!-- Project Selector -->
      <div class="flex-1 min-w-[200px]">
        <label for="projectSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Project</label>
        <select 
          id="projectSelect" 
          [(ngModel)]="selectedProjectId"
          (change)="onProjectChange()"
          class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-gray-700 dark:text-gray-200 dark:bg-gray-800">
          <option *ngFor="let project of projects" [value]="project.id">{{project.name}}</option>
          <option [value]="''">All Projects</option>
        </select>
      </div>
      
      <!-- Search Box -->
      <div class="flex-1 min-w-[200px]">
        <label for="searchInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Search</label>
        <div class="relative">
          <input 
            id="searchInput"
            type="text" 
            [(ngModel)]="searchQuery"
            (keyup.enter)="applySearchFilter()"
            placeholder="Search tickets..."
            class="w-full px-4 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-gray-700 dark:text-gray-200 dark:bg-gray-800">
          <mat-icon class="absolute left-3 top-2 text-gray-400">search</mat-icon>
        </div>
      </div>
      
      <!-- Filter Buttons -->
      <div class="flex gap-2">
        <button 
          (click)="toggleAssigneeFilter()" 
          [class.bg-purple-100]="!filterByAssignee"
          [class.text-purple-700]="!filterByAssignee"
          [class.bg-purple-500]="filterByAssignee"
          [class.text-white]="filterByAssignee"
          class="px-3 py-2 rounded-md flex items-center gap-1 transition-colors">
          <mat-icon class="text-base">{{filterByAssignee ? 'check_box' : 'check_box_outline_blank'}}</mat-icon>
          <span>My Tickets</span>
        </button>
        
        <button 
          (click)="resetFilters()" 
          class="px-3 py-2 bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 rounded-md flex items-center gap-1">
          <mat-icon class="text-base">refresh</mat-icon>
          <span>Reset</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="flex justify-center items-center min-h-[400px]">
    <mat-spinner [diameter]="40"></mat-spinner>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && projects.length === 0" class="text-center py-10 bg-white dark:bg-darksecondry dark:border-gray-700 border rounded-lg shadow-md">
    <mat-icon class="text-gray-400 text-6xl mb-4">view_kanban</mat-icon>
    <h3 class="text-xl font-medium text-gray-700 dark:text-gray-300 mb-2">No Projects Found</h3>
    <p class="text-gray-500 dark:text-gray-400 mb-4">You don't have access to any projects yet.</p>
  </div>

  <!-- Kanban Board -->
  <div *ngIf="!isLoading && projects.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <!-- Columns -->
    <div *ngFor="let column of columns; let i = index" class="bg-white dark:bg-darksecondry dark:border-gray-700 border rounded-lg shadow-md overflow-hidden flex flex-col h-full">
      <!-- Column Header -->
      <div class="bg-gray-50 dark:bg-gray-800 p-4 border-b dark:border-gray-700">
        <h3 class="font-medium text-gray-900 dark:text-gray-100 flex items-center gap-2">
          {{column.name}}
          <span class="text-xs font-normal text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">
            {{column.tickets.length}}
          </span>
        </h3>
      </div>
      
      <!-- Tickets Container - Dropzone -->
      <div
        [id]="i === 0 ? 'todo' : (i === 1 ? 'inprogress' : (i === 2 ? 'resolved' : 'verified'))"
        cdkDropList
        [cdkDropListData]="column.tickets"
        [cdkDropListConnectedTo]="['todo', 'inprogress', 'resolved', 'verified']"
        (cdkDropListDropped)="onDrop($event)"
        class="bg-gray-50 dark:bg-gray-800 p-3 flex-1 min-h-[150px] overflow-y-auto"
        style="max-height: calc(100vh - 300px);">
        
        <!-- Empty Column Message -->
        <div *ngIf="column.tickets.length === 0" class="flex flex-col items-center justify-center text-center p-6 h-full">
          <mat-icon class="text-gray-400 mb-2">inbox</mat-icon>
          <p class="text-sm text-gray-500 dark:text-gray-400">No tickets in this column</p>
        </div>
        
        <!-- Ticket Cards -->
        <div 
          *ngFor="let ticket of column.tickets" 
          cdkDrag
          [cdkDragDisabled]="!canMoveTicket(ticket)"
          class="mb-3 bg-white dark:bg-gray-700 rounded-md shadow overflow-hidden cursor-pointer transition-shadow hover:shadow-md">
          
          <!-- Drag Preview (used when dragging) -->
          <div *cdkDragPreview class="bg-white dark:bg-gray-700 rounded-md shadow-lg p-4 w-72">
            <div class="flex justify-between items-start mb-2">
              <span class="text-xs text-gray-500 dark:text-gray-400">#{{ticket.id}}</span>
              <span 
                [ngClass]="{
                  'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300': ticket.priority === 'LOW',
                  'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300': ticket.priority === 'MEDIUM',
                  'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300': ticket.priority === 'HIGH',
                  'bg-red-600 text-white dark:bg-red-900 dark:text-red-300': ticket.priority === 'CRITICAL'
                }"
                class="text-xs font-medium px-2 py-0.5 rounded-full">
                {{ticket.priority}}
              </span>
            </div>
            <h4 class="font-medium text-gray-900 dark:text-white text-sm mb-1">{{ticket.title}}</h4>
            <p class="text-xs text-gray-600 dark:text-gray-300 line-clamp-2 mb-2">{{ticket.description}}</p>
            <div class="flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
              <span>Project: {{ticket.projectId || 'N/A'}}</span>
              <span>{{formatDate(ticket.createdAt)}}</span>
            </div>
          </div>
          
          <!-- Actual Card Content -->
          <div class="p-4" (click)="ticket.id !== undefined && viewTicket(ticket.id)">
            <div class="flex justify-between items-start mb-2">
              <span class="text-xs text-gray-500 dark:text-gray-400">#{{ticket.id}}</span>
              <span 
                [ngClass]="{
                  'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300': ticket.priority === 'LOW',
                  'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300': ticket.priority === 'MEDIUM',
                  'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300': ticket.priority === 'HIGH',
                  'bg-red-600 text-white dark:bg-red-900 dark:text-red-300': ticket.priority === 'CRITICAL'
                }"
                class="text-xs font-medium px-2 py-0.5 rounded-full">
                {{ticket.priority}}
              </span>
            </div>
            <h4 class="font-medium text-gray-900 dark:text-white text-sm mb-1">{{ticket.title}}</h4>
            <p class="text-xs text-gray-600 dark:text-gray-300 line-clamp-2 mb-2">{{ticket.description}}</p>
            
            <div class="flex justify-between items-center mt-3 text-xs text-gray-500 dark:text-gray-400">
              <div class="flex items-center">
                <mat-icon class="text-sm mr-1">person</mat-icon>
                <span class="truncate max-w-[100px]">{{ticket.userEmail || ticket.assignedToEmail || 'Unassigned'}}</span>
              </div>
              <span>{{formatDate(ticket.createdAt)}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
